<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>RL Swarm Dashboard</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@500&family=Inter:wght@400;500&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .header-font { font-family: 'Orbitron', sans-serif; }
        .theme-transition * { transition: background-color 0.3s ease, color 0.3s ease; }
        .tooltip { position: absolute; pointer-events: none; opacity: 0; transition: opacity 0.3s; }
        .chart-toggle.active { background-color: #3b82f6; color: white; }
    </style>
</head>
<body class="theme-transition bg-gray-50 dark:bg-gray-900 text-gray-900 dark:text-gray-100 p-6 min-h-screen">
    <header class="mb-10 text-center relative">
        <div class="flex justify-between items-center">
            <div>
                <h1 class="header-font text-4xl sm:text-5xl font-extrabold text-primary-dark dark:text-primary-light drop-shadow">
                    RL Swarm Dashboard
                </h1>
                <p class="text-gray-600 dark:text-gray-400 mt-3 text-sm">Visualizing Decentralized Collective Learning</p>
            </div>
            <div class="flex items-center space-x-4">
                <button id="theme-toggle" class="p-2 rounded-full bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 transition">
                    <svg id="theme-icon" xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-700 dark:text-gray-300" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path id="theme-path" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"/>
                    </svg>
                </button>
            </div>
        </div>
    </header>

    <main class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-10">
        <!-- Swarm Overview -->
        <section class="bg-white dark:bg-gray-800 rounded-xl p-6 border border-gray-200 dark:border-gray-700 shadow-sm">
            <h2 class="header-font text-xl text-primary-dark dark:text-primary-light font-semibold mb-4">Swarm Overview</h2>
            <div class="grid grid-cols-2 gap-4">
                <div class="bg-gray-50 dark:bg-gray-700/50 p-4 rounded-lg">
                    <p class="text-gray-500 dark:text-gray-400 text-sm">Total Nodes</p>
                    <p id="total-nodes" class="text-2xl font-bold">--</p>
                </div>
                <div class="bg-gray-50 dark:bg-gray-700/50 p-4 rounded-lg">
                    <p class="text-gray-500 dark:text-gray-400 text-sm">Avg Reward</p>
                    <p id="avg-reward" class="text-2xl font-bold">--</p>
                </div>
                <div class="bg-gray-50 dark:bg-gray-700/50 p-4 rounded-lg">
                    <p class="text-gray-500 dark:text-gray-400 text-sm">Total Staked</p>
                    <p id="total-staked" class="text-2xl font-bold">--</p>
                </div>
                <div class="bg-gray-50 dark:bg-gray-700/50 p-4 rounded-lg">
                    <p class="text-gray-500 dark:text-gray-400 text-sm">Swarm Health</p>
                    <p id="swarm-health" class="text-2xl font-bold">--</p>
                </div>
            </div>
        </section>

        <!-- Node Distribution -->
        <section class="bg-white dark:bg-gray-800 rounded-xl p-6 border border-gray-200 dark:border-gray-700 shadow-sm">
            <div class="flex justify-between items-center mb-4">
                <h2 class="header-font text-xl text-primary-dark dark:text-primary-light font-semibold">Node Distribution</h2>
                <div class="flex space-x-2">
                    <button class="chart-toggle active px-3 py-1 text-xs bg-blue-500 text-white rounded-md" data-type="bar">Bars</button>
                    <button class="chart-toggle px-3 py-1 text-xs bg-gray-100 dark:bg-gray-700 rounded-md" data-type="pie">Pie</button>
                </div>
            </div>
            <div id="node-distribution" class="h-64"></div>
        </section>

        <!-- Reward Performance -->
        <section class="md:col-span-2 bg-white dark:bg-gray-800 rounded-xl p-6 border border-gray-200 dark:border-gray-700 shadow-sm">
            <div class="flex justify-between items-center mb-4">
                <h2 class="header-font text-xl text-primary-dark dark:text-primary-light font-semibold">Node Reward Performance</h2>
                <button id="export-btn" class="px-3 py-1 text-sm bg-green-100 dark:bg-green-900/50 text-green-800 dark:text-green-200 rounded-md hover:bg-green-200 dark:hover:bg-green-800 transition">
                    Export Data
                </button>
            </div>
            <div id="node-performance" class="h-96"></div>
            <div id="node-tooltip" class="tooltip bg-white dark:bg-gray-700 p-3 rounded-lg shadow-lg border border-gray-200 dark:border-gray-600 text-sm"></div>
        </section>
    </main>

    <script>
        // Theme Management
        const themeToggle = document.getElementById('theme-toggle');
        const themeIcon = document.getElementById('theme-icon');
        const themePath = document.getElementById('theme-path');
        let currentTheme = localStorage.getItem('theme') || (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');
        
        document.documentElement.classList.toggle('dark', currentTheme === 'dark');
        updateThemeIcon();
        
        themeToggle.addEventListener('click', () => {
            currentTheme = currentTheme === 'dark' ? 'light' : 'dark';
            document.documentElement.classList.toggle('dark', currentTheme === 'dark');
            localStorage.setItem('theme', currentTheme);
            updateThemeIcon();
            updateChartThemes();
        });

        function updateThemeIcon() {
            themePath.setAttribute('d', currentTheme === 'dark' ? 
                'M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z' :
                'M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z');
        }

        // Real-Time Data Connection
        let nodePerformanceChart, nodeDistributionChart;
        let allNodesData = [];
        let socket;
        
        function connectWebSocket() {
            const protocol = window.location.protocol === 'https:' ? 'wss://' : 'ws://';
            const host = window.location.hostname || 'localhost';
            socket = new WebSocket(${protocol}${host}:8000/api/ws);

            socket.onmessage = (event) => {
                const data = JSON.parse(event.data);
                allNodesData = data.nodes || [];
                updateDashboard(data);
            };

            socket.onclose = () => setTimeout(connectWebSocket, 3000);
        }

        async function fetchData() {
            try {
                const response = await fetch('http://localhost:8000/api/swarm');
                const data = await response.json();
                allNodesData = data.nodes || [];
                updateDashboard(data);
            } catch (error) {
                console.error('Failed to fetch data:', error);
            }
        }

        // Dashboard Updates
        function updateDashboard(swarmData) {
            document.getElementById('total-nodes').textContent = swarmData.total_nodes || '--';
            document.getElementById('avg-reward').textContent = swarmData.average_reward?.toFixed(2) || '--';
            document.getElementById('total-staked').textContent = swarmData.total_staked?.toLocaleString() || '--';
            
            const healthValue = swarmData.onchain?.health_score ?? swarmData.average_health;
            document.getElementById('swarm-health').textContent = healthValue ? ${healthValue.toFixed(1)}% : '--';

            updateNodePerformanceChart(swarmData.nodes || []);
            updateNodeDistributionChart(swarmData.nodes || []);
        }

        // Chart Functions
        function updateNodePerformanceChart(nodesData = []) {
            const isDark = currentTheme === 'dark';
            const chartData = [{
                x: nodesData.map(n => n.id),
                y: nodesData.map(n => n.reward),
                type: 'bar',
                marker: { color: isDark ? '#06b6d4' : '#3b82f6' }
            }];
            
            const layout = {
                title: 'Node Rewards',
                font: { color: isDark ? '#f3f4f6' : '#111827' },
                plot_bgcolor: 'transparent',
                paper_bgcolor: 'transparent',
                xaxis: { title: 'Node ID' },
                yaxis: { title: 'Reward' },
                margin: { t: 40, l: 60, r: 40, b: 100 }
            };
            
            if (!nodePerformanceChart) {
                nodePerformanceChart = Plotly.newPlot('node-performance', chartData, layout);
            } else {
                Plotly.react('node-performance', chartData, layout);
            }
        }

        function updateNodeDistributionChart(nodesData = [], chartType = 'bar') {
            const isDark = currentTheme === 'dark';
            const ranges = [
                { min: 0, max: 5, label: '0-5' },
                { min: 5, max: 10, label: '5-10' },
                { min: 10, max: 15, label: '10-15' },
                { min: 15, max: Infinity, label: '15+' }
            ];
            
            const distribution = ranges.map(range => ({
                range: range.label,
                count: nodesData.filter(n => n.reward >= range.min && n.reward < range.max).length
            }));
            
            const chartData = chartType === 'pie' ? [{
                values: distribution.map(d => d.count),
                labels: distribution.map(d => d.range),
                type: 'pie',
                marker: { colors: isDark ? ['#06b6d4', '#0ea5e9', '#3b82f6', '#6366f1'] : ['#3b82f6', '#2563eb', '#1d4ed8', '#1e40af'] }
            }] : [{
                x: distribution.map(d => d.range),
                y: distribution.map(d => d.count),
                type: 'bar',
                marker: { color: isDark ? '#10b981' : '#10b981' }
            }];
            
            const layout = {
                title: chartType === 'pie' ? 'Reward Distribution' : 'Nodes by Reward Range',
                font: { color: isDark ? '#f3f4f6' : '#111827' },
                plot_bgcolor: 'transparent',
                paper_bgcolor: 'transparent'
            };
            
            if (!nodeDistributionChart) {
                nodeDistributionChart = Plotly.newPlot('node-distribution', chartData, layout);
            } else {
                Plotly.react('node-distribution', chartData, layout);
            }
        }

        function updateChartThemes() {
            if (nodePerformanceChart) updateNodePerformanceChart(allNodesData);
            if (nodeDistributionChart) {
                const currentType = document.querySelector('.chart-toggle.active')?.dataset.type || 'bar';
                updateNodeDistributionChart(allNodesData, currentType);
            }
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            connectWebSocket();
            fetchData();
            
            // Chart toggle handlers
            document.querySelectorAll('.chart-toggle').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.chart-toggle').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    updateNodeDistributionChart(allNodesData, btn.dataset.type);
                });
            });

            // Export handler
            document.getElementById('export-btn').addEventListener('click', () => {
                const csvContent = "data:text/csv;charset=utf-8," +
                    "Node ID,Reward,Staked,Health Score,Last Active,Status\n" +
                    allNodesData.map(node => 
                        ${node.id},${node.reward},${node.staked},${node.health_score},${node.last_active},${node.status}
                    ).join("\n");
                
                const link = document.createElement("a");
                link.setAttribute("href", encodeURI(csvContent));
                link.setAttribute("download", "swarm_data.csv");
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            });
        });
    </script>
</body>
</html>