<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>RL Swarm Dashboard</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@500&family=Inter:wght@400;500&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Inter', sans-serif; }
        .header-font { font-family: 'Orbitron', sans-serif; }
        .theme-transition * { transition: background-color 0.3s ease, color 0.3s ease; }
        .chart-toggle.active { background-color: #3b82f6 !important; color: white !important; }
    </style>

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: { dark: '#06b6d4', light: '#3b82f6' },
                        secondary: { dark: '#10b981', light: '#10b981' }
                    }
                }
            }
        }
    </script>
</head>

<body class="theme-transition bg-gray-50 dark:bg-gray-900 text-gray-900 dark:text-gray-100 p-6 min-h-screen">
    <!-- Simulation Controls -->
    <div id="simulation-panel" class="fixed inset-0 bg-black/50 z-50 hidden items-center justify-center">
        <div class="bg-white dark:bg-gray-800 rounded-xl p-6 w-full max-w-md">
            <div class="flex justify-between items-center mb-4">
                <h3 class="header-font text-xl">Simulation Controls</h3>
                <button id="close-simulation" class="text-gray-500 hover:text-gray-700">
                    âœ•
                </button>
            </div>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm mb-2">Node Count: <span id="node-count-value">15</span></label>
                    <input type="range" id="node-count" min="5" max="50" value="15" class="w-full">
                </div>
                <button id="run-simulation" class="w-full py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                    Start Simulation
                </button>
            </div>
        </div>
    </div>

    <!-- Main Header -->
    <header class="mb-8">
        <div class="flex justify-between items-center">
            <div>
                <h1 class="header-font text-3xl sm:text-4xl text-blue-600 dark:text-blue-400">
                    RL Swarm Dashboard
                </h1>
                <p class="text-gray-600 dark:text-gray-300 mt-1 text-sm">
                    Real-time Node Network Visualization
                </p>
            </div>
            <div class="flex gap-2">
                <button id="simulation-btn" class="px-3 py-1.5 bg-blue-100 dark:bg-blue-900/20 text-blue-600 dark:text-blue-300 rounded-lg text-sm">
                    Simulate
                </button>
                <button id="theme-toggle" class="p-1.5 rounded-lg bg-gray-200 dark:bg-gray-700 hover:bg-gray-300">
                    ðŸŒ“
                </button>
            </div>
        </div>
    </header>

    <!-- Dashboard Grid -->
    <main class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <!-- Metrics Cards -->
        <div class="grid grid-cols-2 gap-4">
            <div class="bg-white dark:bg-gray-800 p-4 rounded-xl">
                <p class="text-gray-500 dark:text-gray-300 text-sm">Total Nodes</p>
                <p id="total-nodes" class="text-2xl font-bold">-</p>
            </div>
            <div class="bg-white dark:bg-gray-800 p-4 rounded-xl">
                <p class="text-gray-500 dark:text-gray-300 text-sm">Avg Reward</p>
                <p id="avg-reward" class="text-2xl font-bold">-</p>
            </div>
            <div class="bg-white dark:bg-gray-800 p-4 rounded-xl">
                <p class="text-gray-500 dark:text-gray-300 text-sm">Total Staked</p>
                <p id="total-staked" class="text-2xl font-bold">-</p>
            </div>
            <div class="bg-white dark:bg-gray-800 p-4 rounded-xl">
                <p class="text-gray-500 dark:text-gray-300 text-sm">Network Health</p>
                <p id="swarm-health" class="text-2xl font-bold">-</p>
            </div>
        </div>

        <!-- Distribution Chart -->
        <div class="bg-white dark:bg-gray-800 p-4 rounded-xl">
            <div class="flex justify-between items-center mb-4">
                <h2 class="font-semibold">Reward Distribution</h2>
                <div class="flex gap-2">
                    <button class="chart-toggle active px-2 py-1 text-xs bg-blue-500 text-white rounded" data-type="bar">
                        Bars
                    </button>
                    <button class="chart-toggle px-2 py-1 text-xs bg-gray-100 dark:bg-gray-700 rounded" data-type="pie">
                        Pie
                    </button>
                </div>
            </div>
            <div id="node-distribution" class="h-64"></div>
        </div>

        <!-- Main Performance Chart -->
        <div class="md:col-span-2 bg-white dark:bg-gray-800 p-4 rounded-xl">
            <div class="flex justify-between items-center mb-4">
                <h2 class="font-semibold">Node Performance</h2>
                <button id="export-btn" class="px-3 py-1 text-sm bg-green-100 dark:bg-green-900/20 text-green-600 dark:text-green-300 rounded-lg">
                    Export Data
                </button>
            </div>
            <div id="node-performance" class="h-96"></div>
        </div>
    </main>

    <script>
        // Configuration
        let currentTheme = localStorage.getItem('theme') || 'light';
        let chartInstances = { performance: null, distribution: null };
        let socketConnection = null;

        // Theme Management
        function updateTheme() {
            document.documentElement.classList.toggle('dark', currentTheme === 'dark');
            localStorage.setItem('theme', currentTheme);
            refreshCharts();
        }

        document.getElementById('theme-toggle').addEventListener('click', () => {
            currentTheme = currentTheme === 'dark' ? 'light' : 'dark';
            updateTheme();
        });

        // Data Connection
        async function connectWebSocket() {
            const wsProtocol = window.location.protocol === 'https:' ? 'wss://' : 'ws://';
            const wsHost = window.location.host || 'localhost:8000';
            
            try {
                socketConnection = new WebSocket(`${wsProtocol}${wsHost}/api/ws`);
                
                socketConnection.onmessage = (event) => {
                    const data = JSON.parse(event.data);
                    updateDisplay(data);
                };

                socketConnection.onclose = () => setTimeout(connectWebSocket, 3000);

            } catch (error) {
                console.error('WebSocket Error:', error);
            }
        }

        // Data Handling
        function updateDisplay(data) {
            // Update metrics
            document.getElementById('total-nodes').textContent = data.total_nodes || '-';
            document.getElementById('avg-reward').textContent = data.average_reward?.toFixed(2) || '-';
            document.getElementById('total-staked').textContent = data.total_staked?.toLocaleString() || '-';
            document.getElementById('swarm-health').textContent = 
                `${(data.average_health || 0).toFixed(1)}%` || '-';

            // Update charts
            renderPerformanceChart(data.nodes || []);
            renderDistributionChart(data.nodes || []);
        }

        // Chart Rendering
        function renderPerformanceChart(nodes) {
            const isDark = currentTheme === 'dark';
            const layout = {
                title: 'Node Rewards',
                paper_bgcolor: 'transparent',
                plot_bgcolor: 'transparent',
                font: { color: isDark ? '#fff' : '#000' },
                xaxis: { title: 'Node ID', tickangle: -45 },
                yaxis: { title: 'Reward Value' },
                margin: { t: 40, l: 60, r: 30, b: 100 }
            };

            const trace = {
                x: nodes.map(n => n.id),
                y: nodes.map(n => n.reward),
                type: 'bar',
                marker: { color: isDark ? '#06b6d4' : '#3b82f6' }
            };

            if (chartInstances.performance) {
                Plotly.react('node-performance', [trace], layout);
            } else {
                chartInstances.performance = Plotly.newPlot('node-performance', [trace], layout);
            }
        }

        function renderDistributionChart(nodes, type = 'bar') {
            const isDark = currentTheme === 'dark';
            const ranges = [
                { min: 0, max: 5, label: '0-5' },
                { min: 5, max: 10, label: '5-10' },
                { min: 10, max: 15, label: '10-15' },
                { min: 15, max: Infinity, label: '15+' }
            ];

            const distribution = ranges.map(range => ({
                label: range.label,
                count: nodes.filter(n => n.reward >= range.min && n.reward < range.max).length
            }));

            const layout = {
                title: type === 'pie' ? 'Reward Distribution' : 'Nodes by Reward',
                paper_bgcolor: 'transparent',
                plot_bgcolor: 'transparent',
                font: { color: isDark ? '#fff' : '#000' }
            };

            const trace = type === 'pie' ? {
                values: distribution.map(d => d.count),
                labels: distribution.map(d => d.label),
                type: 'pie',
                marker: { colors: ['#3b82f6', '#2563eb', '#1d4ed8', '#1e40af'] }
            } : {
                x: distribution.map(d => d.label),
                y: distribution.map(d => d.count),
                type: 'bar',
                marker: { color: '#10b981' }
            };

            if (chartInstances.distribution) {
                Plotly.react('node-distribution', [trace], layout);
            } else {
                chartInstances.distribution = Plotly.newPlot('node-distribution', [trace], layout);
            }
        }

        // UI Interactions
        document.querySelectorAll('.chart-toggle').forEach(button => {
            button.addEventListener('click', () => {
                document.querySelectorAll('.chart-toggle').forEach(btn => btn.classList.remove('active'));
                button.classList.add('active');
                renderDistributionChart(allNodes, button.dataset.type);
            });
        });

        document.getElementById('simulation-btn').addEventListener('click', () => {
            document.getElementById('simulation-panel').classList.remove('hidden');
        });

        document.getElementById('close-simulation').addEventListener('click', () => {
            document.getElementById('simulation-panel').classList.add('hidden');
        });

        // Initialization
        document.addEventListener('DOMContentLoaded', () => {
            updateTheme();
            connectWebSocket();
        });
    </script>
</body>
</html>